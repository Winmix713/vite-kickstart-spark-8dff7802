import React, { createContext, useContext, useEffect, useState } from 'react' import { User, Session } from '@supabase/supabase-js' import { supabase } from '@/integrations/supabase/client' export const UserRole = { USER: 'user', ANALYST: 'analyst', ADMIN: 'admin' } const AuthContext = createContext(undefined) export function useAuth() { const context = useContext(AuthContext) if (context === undefined) { throw new Error('useAuth must be used within an AuthProvider') } return context } export function AuthProvider({ children }) { const[user, setUser] = useState(null) const[profile, setProfile] = useState(null) const[session, setSession] = useState(null) const[loading, setLoading] = useState(true) const[error, setError] = useState(null) // Fetch user profile from database const fetchUserProfile = async (userId, userEmail) => { try { const { data: profileData, error: profileError } = await supabase .from('user_profiles') .select('*') .eq('id', userId) .single() if (profileError) { if (profileError.code === 'PGRST116') { // Profile doesn't exist, create one const newProfile = { id: userId, email: userEmail || '', full_name: null, role: 'user', avatar_url: null, created_at: new Date().toISOString(), updated_at: new Date().toISOString() } const { error: insertError } = await supabase .from('user_profiles') .insert([newProfile]) if (insertError) { console.error('Error creating profile:', insertError) setError('Failed to create user profile') } else { setProfile(newProfile) } } else { console.error('Error fetching profile:', profileError) setError('Failed to load user profile') } } else { setProfile(profileData) } } catch (err) { console.error('Unexpected error loading profile:', err) setError('Unexpected error loading profile') } } useEffect(() => { // Get initial session const getSession = async () => { try { const { data } = await supabase.auth.getSession() setSession(session) setUser(session?.user ?? null) if (session?.user) { await fetchUserProfile(session.user.id, session.user.email) } setLoading(false) } catch (err) { console.error('Error getting session:', err) setError('Failed to load session') setLoading(false) } } getSession() // Listen for auth changes const { data } = supabase.auth.onAuthStateChange( async (event, session) => { setSession(session) setUser(session?.user ?? null) setError(null) if (session?.user) { await fetchUserProfile(session.user.id, session.user.email) } else { setProfile(null) } setLoading(false) } ) return () => subscription.unsubscribe() }, []) const signUp = async (email, password, fullName) => { const { data, error } = await supabase.auth.signUp({ email, password, options } }) if (error) throw error return data } const signIn = async (email, password) => { const { data, error } = await supabase.auth.signInWithPassword({ email, password }) if (error) throw error return data } const signOut = async () => { const { error } = await supabase.auth.signOut() if (error) throw error } const resetPassword = async (email) => { const { data, error } = await supabase.auth.resetPasswordForEmail(email) if (error) throw error return data } const value = { user, profile, session, loading, error, signUp, signIn, signOut, resetPassword } return ( <AuthContext.Provider value={value}> {children} </AuthContext.Provider> ) }