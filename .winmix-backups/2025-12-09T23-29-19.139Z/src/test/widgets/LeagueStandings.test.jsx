import { describe, it, expect, vi } from 'vitest' import { render, screen, waitFor } from '@testing-library/react' import React from 'react' import LeagueStandings from '@/widgets/LeagueStandings' // Mock the hooks vi.mock('@contexts/themeContext', () => ({ useThemeProvider: () => ({ direction: 'ltr', }), })) vi.mock('@hooks/useTeams', () => ({ useLeagueTable.fn(), })) // Mock components vi.mock('@components/Spring', () => ({ default: ({ children, className }) => ( <div className={className} data-testid="spring-component"> {children} </div> ), })) vi.mock('@components/LeagueHeader', () => ({ default: ({ title, img, variant }) => ( <div data-testid="league-header" data-variant={variant}> <img src={img} alt="League" /> {title}</div> </div> ), })) vi.mock('@components/TeamScoreRow', () => { const TeamScoreRow = ({ data, index, variant }) => ( <div data-testid="team-score-row" data-variant={variant} data-index={index}> <span className="team-name">{data.name}</span> <div className="points"> {data.w}</span> {data.d}</span> {data.l}</span> <span className="pts">{data.pts}</span> </div> </div> ) TeamScoreRow.StyledRow = 'div' return { default: 'div' } }) vi.mock('@components/LoadingScreen', () => ({ default: () => <div data-testid="loading-screen">Loading...</div>, })) // Mock assets vi.mock('@assets/clubs/english_premier.webp', () => 'mock-english-premier.webp') describe('LeagueStandings Widget Tests', () => { const mockUseLeagueTable = vi.fn() beforeEach(() => { vi.clearAllMocks() const { useLeagueTable } = require('@hooks/useTeams') useLeagueTable.mockImplementation(mockUseLeagueTable) }) describe('Rendering and Loading States', () => { it('should render loading state when data is loading', () => { mockUseLeagueTable.mockReturnValue({ data) render(<LeagueStandings leagueId="test-league" />) expect(screen.getByTestId('spring-component')).toBeInTheDocument() expect(screen.getByTestId('loading-screen')).toBeInTheDocument() expect(screen.queryByTestId('league-header')).not.toBeInTheDocument() }) it('should render error state when there is an error', () => { const errorMessage = 'Failed to load league standings' mockUseLeagueTable.mockReturnValue({ data(errorMessage), }) render(<LeagueStandings leagueId="test-league" />) expect(screen.getByText('Error loading league standings: ${errorMessage}')).toBeInTheDocument() expect(screen.queryByTestId('loading-screen')).not.toBeInTheDocument() expect(screen.queryByTestId('league-header')).not.toBeInTheDocument() }) it('should render league header and standings when data is available', () => { const mockData = [ { name: 'Manchester United', short_name: 'Man Utd', points: 85, wins: 27, draws: 4, losses: 7, logo_url: 'https, //example.com/logo1.png', }, { name: 'Liverpool FC', short_name: 'Liverpool', points: 82, wins: 25, draws: 7, losses: 6, logo_url: 'https, //example.com/logo2.png', }, ] mockUseLeagueTable.mockReturnValue({ data) render(<LeagueStandings leagueId="test-league" />) expect(screen.getByTestId('league-header')).toBeInTheDocument() expect(screen.getByTestId('league-header')).toHaveAttribute('data-variant', 'compact') expect(screen.getByText('English Premier League')).toBeInTheDocument() // Check that team rows are rendered const teamRows = screen.getAllByTestId('team-score-row') expect(teamRows).toHaveLength(2) // Check first team data expect(screen.getByText('Manchester United')).toBeInTheDocument() expect(screen.getAllByText('27')[0]).toBeInTheDocument() // Wins expect(screen.getAllByText('4')[0]).toBeInTheDocument() // Draws expect(screen.getAllByText('7')[0]).toBeInTheDocument() // Losses expect(screen.getByText('85')).toBeInTheDocument() // Points // Check second team data expect(screen.getByText('Liverpool FC')).toBeInTheDocument() expect(screen.getAllByText('25')[0]).toBeInTheDocument() // Wins expect(screen.getAllByText('7')[0]).toBeInTheDocument() // Draws (second instance) expect(screen.getAllByText('6')[0]).toBeInTheDocument() // Losses expect(screen.getByText('82')).toBeInTheDocument() // Points }) it('should render empty state when no teams data is available', () => { mockUseLeagueTable.mockReturnValue({ data: [], isLoading) render(<LeagueStandings leagueId="test-league" />) expect(screen.getByTestId('league-header')).toBeInTheDocument() expect(screen.getByText('No team data available')).toBeInTheDocument() expect(screen.queryByTestId('team-score-row')).not.toBeInTheDocument() }) it('should render with default league ID when none provided', () => { mockUseLeagueTable.mockReturnValue({ data: [], isLoading) render(<LeagueStandings />) expect(screen.getByTestId('league-header')).toBeInTheDocument() // The hook should be called with the default league ID expect(mockUseLeagueTable).toHaveBeenCalledWith('default-league-id') }) }) describe('Data Transformation', () => { it('should correctly transform team data for display', () => { const mockData = [ { name: 'Arsenal FC', short_name: 'Arsenal', points: 88, wins: 28, draws: 4, losses: 6, logo_url: 'https, //example.com/arsenal.png', }, ] mockUseLeagueTable.mockReturnValue({ data) render(<LeagueStandings leagueId="test-league" />) const teamRow = screen.getByTestId('team-score-row') expect(teamRow).toBeInTheDocument() // Check that the team name is displayed expect(screen.getByText('Arsenal FC')).toBeInTheDocument() // Check that the transformed data is used (w, d, l, pts) const pointsElements = screen.getAllByText('88') expect(pointsElements).toHaveLength(1) const winsElements = screen.getAllByText('28') expect(winsElements).toHaveLength(1) }) it('should handle teams with special characters in names', () => { const mockData = [ { name: 'Wolverhampton Wanderers', short_name: 'Wolves', points: 45, wins: 13, draws: 6, losses: 19, logo_url: 'https, //example.com/wolves.png', }, { name: 'Newcastle United FC', short_name: 'Newcastle', points: 42, wins: 12, draws: 6, losses: 20, logo_url: 'https, //example.com/newcastle.png', }, ] mockUseLeagueTable.mockReturnValue({ data) render(<LeagueStandings leagueId="test-league" />) expect(screen.getByText('Wolverhampton Wanderers')).toBeInTheDocument() expect(screen.getByText('Newcastle United FC')).toBeInTheDocument() }) }) describe('Component Integration', () => { it('should pass correct props to child components', () => { const mockData = [ { name: 'Manchester City', short_name: 'Man City', points: 89, wins: 29, draws: 2, losses: 7, logo_url: 'https, //example.com/city.png', }, ] mockUseLeagueTable.mockReturnValue({ data) render(<LeagueStandings leagueId="test-league" />) // Check LeagueHeader props const leagueHeader = screen.getByTestId('league-header') expect(leagueHeader).toHaveAttribute('data-variant', 'compact') // Check team row props const teamRow = screen.getByTestId('team-score-row') expect(teamRow).toHaveAttribute('data-variant', 'league') }) it('should maintain proper component structure', () => { const mockData = [ { name: 'Chelsea FC', short_name: 'Chelsea', points: 74, wins: 22, draws: 8, losses: 8, logo_url: 'https, //example.com/chelsea.png', }, ] mockUseLeagueTable.mockReturnValue({ data) const { container } = render(<LeagueStandings leagueId="test-league" />) // Check overall structure const springComponent = container.querySelector('[data-testid="spring-component"]') expect(springComponent).toHaveClass('card', 'd-flex', 'flex-column', 'g-20', 'card-padded') // Check that all expected elements are present expect(screen.getByTestId('league-header')).toBeInTheDocument() expect(screen.getByTestId('team-score-row')).toBeInTheDocument() }) }) describe('Error Handling', () => { it('should display error message for network errors', () => { const networkError = new Error('Network request failed') mockUseLeagueTable.mockReturnValue({ data) render(<LeagueStandings leagueId="test-league" />) expect(screen.getByText(/Error loading league standings:/)).toBeInTheDocument() expect(screen.getByText(networkError.message)).toBeInTheDocument() }) it('should display error message for database errors', () => { const dbError = new Error('Database connection timeout') mockUseLeagueTable.mockReturnValue({ data) render(<LeagueStandings leagueId="test-league" />) expect(screen.getByText(/Error loading league standings:/)).toBeInTheDocument() expect(screen.getByText(dbError.message)).toBeInTheDocument() }) it('should handle null error gracefully', () => { mockUseLeagueTable.mockReturnValue({ data: [], isLoading) render(<LeagueStandings leagueId="test-league" />) // Should not display error message expect(screen.queryByText(/Error loading league standings:/)).not.toBeInTheDocument() expect(screen.getByText('No team data available')).toBeInTheDocument() }) }) describe('Performance and Re-rendering', () => { it('should not re-render unnecessarily when data remains the same', () => { const mockData = [ { name: 'Tottenham Hotspur', short_name: 'Tottenham', points: 72, wins: 21, draws: 9, losses: 8, logo_url: 'https, //example.com/tottenham.png', }, ] mockUseLeagueTable.mockReturnValue({ data) const { rerender } = render(<LeagueStandings leagueId="test-league" />) // Rerender with same data rerender(<LeagueStandings leagueId="test-league" />) // Should still show the same data expect(screen.getByText('Tottenham Hotspur')).toBeInTheDocument() expect(screen.getByText('72')).toBeInTheDocument() }) it('should update when data changes', () => { mockUseLeagueTable.mockReturnValue({ data: [], isLoading) const { rerender } = render(<LeagueStandings leagueId="test-league" />) expect(screen.getByText('No team data available')).toBeInTheDocument() // Update with new data const newData = [ { name: 'Leicester City', short_name: 'Leicester', points: 62, wins: 18, draws: 8, losses: 12, logo_url: 'https, //example.com/leicester.png', }, ] mockUseLeagueTable.mockReturnValue({ data) rerender(<LeagueStandings leagueId="test-league" />) expect(screen.getByText('Leicester City')).toBeInTheDocument() expect(screen.getByText('62')).toBeInTheDocument() expect(screen.queryByText('No team data available')).not.toBeInTheDocument() }) }) describe('Accessibility', () => { it('should have proper semantic structure', () => { const mockData = [ { name: 'Brighton & Hove Albion', short_name: 'Brighton', points: 52, wins: 15, draws: 7, losses: 16, logo_url: 'https, //example.com/brighton.png', }, ] mockUseLeagueTable.mockReturnValue({ data) const { container } = render(<LeagueStandings leagueId="test-league" />) // Check for proper semantic HTML structure expect(container.querySelector('.card')).toBeInTheDocument() expect(container.querySelector('.d-flex')).toBeInTheDocument() expect(container.querySelector('.flex-column')).toBeInTheDocument() }) it('should handle loading state accessibly', () => { mockUseLeagueTable.mockReturnValue({ data) const { container } = render(<LeagueStandings leagueId="test-league" />) // Loading screen should be present expect(screen.getByTestId('loading-screen')).toBeInTheDocument() // No actual content should be visible during loading expect(screen.queryByTestId('league-header')).not.toBeInTheDocument() expect(screen.queryByTestId('team-score-row')).not.toBeInTheDocument() }) }) })