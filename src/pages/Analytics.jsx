import { useEffect, useMemo, useState } from 'react'; // Layout import PageHeader from '@layout/PageHeader'; import AppGrid from '@layout/AppGrid'; import WidgetGroup from '@components/WidgetGroup'; // Services import { supabase } from '@/integrations/supabase/client'; // Utilities import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts'; function formatDate(dateIso) { const d = new Date(dateIso); const year = d.getUTCFullYear(); const month = String(d.getUTCMonth() + 1).padStart(2, '0'); const day = String(d.getUTCDate()).padStart(2, '0'); return '${year}-${month}-${day}'; } const SummaryStatsWidget = ({ summary, cssScoreCount }) => { return ( <WidgetGroup> <div className="grid grid-cols-1 md:grid-cols-3 gap-4"> <div className="rounded-2xl bg-card ring-1 ring-border overflow-hidden p-6"> <div className="text-xs font-semibold text-muted-foreground mb-2">Total Evaluated</div> <div className="text-3xl font-bold text-foreground">{summary.total}</div> </div> <div className="rounded-2xl bg-card ring-1 ring-border overflow-hidden p-6"> <div className="text-xs font-semibold text-muted-foreground mb-2">Overall Accuracy</div> <div className="text-3xl font-bold text-green-500">{summary.accuracy}%</div> </div> <div className="rounded-2xl bg-card ring-1 ring-border overflow-hidden p-6"> <div className="text-xs font-semibold text-muted-foreground mb-2">Calibration Error</div> <div className="text-3xl font-bold text-blue-500">{summary.avgCalibrationError}</div> <p className="text-xs text-muted-foreground mt-2">|p - y| average (lower is better)</p> </div> </div> </WidgetGroup> ); }; const PerformanceChartWidget = ({ data, cssScoreCount }) => { return ( <WidgetGroup> <div className="rounded-2xl bg-card ring-1 ring-border overflow-hidden p-6"> <h3 className="text-lg font-semibold mb-4">Performance Over Time</h3> {cssScoreCount === 0 && ( <div className="p-4 rounded-lg mb-6 border border-yellow-500/20 bg-yellow-500/10 text-yellow-500 text-sm"> No CSS scores available yet. Predictions are being processed. </div> )} {data.length > 0 ? ( <div style={{ width: '100%', height: 300 }}> <ResponsiveContainer width="100%" height="100%"> <LineChart data={data}> <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" /> <XAxis dataKey="date" stroke="rgba(255,255,255,0.5)" tick={{ fontSize: 12 }} /> <YAxis stroke="rgba(255,255,255,0.5)" tick={{ fontSize: 12 }} domain={[0, 100]} /> <Tooltip contentStyle={{ backgroundColor: 'rgba(0,0,0,0.8)', border: '1px solid rgba(255,255,255,0.2)' }} formatter={(value) => '${value.toFixed(1)}%'} /> <Legend wrapperStyle={{ paddingTop: '20px' }} /> <Line type="monotone" dataKey="overall" stroke="#10b981" name="Overall" dot={{ r: 3 }} isAnimationActive /> <Line type="monotone" dataKey="home_win" stroke="#f59e0b" name="Home Win" dot={{ r: 2 }} /> <Line type="monotone" dataKey="draw" stroke="#6366f1" name="Draw" dot={{ r: 2 }} /> <Line type="monotone" dataKey="away_win" stroke="#ef4444" name="Away Win" dot={{ r: 2 }} /> </LineChart> </ResponsiveContainer> </div> ) : ( <div className="text-center text-muted-foreground py-12"> No performance data available yet </div> )} </div> </WidgetGroup> ); }; export default function AnalyticsPage() { const[loading, setLoading] = useState(true); const[points, setPoints] = useState([]); const[summary, setSummary] = useState({ total: 0, accuracy: 0, avgCalibrationError: 0 }); const[cssScoreCount, setCssScoreCount] = useState(0); useEffect(() => { load(); }, []); async function load() { try { setLoading(true); const since = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(); const { data, error } = await supabase .from('predictions') .select('created_at, predicted_outcome, confidence_score, css_score, was_correct') .gte('created_at', since) .order('created_at', { ascending: true }); if (error) throw error; const rows = (data || []); const byDate = new Map(); for (const r of rows) { const key = formatDate(r.created_at); if (!byDate.has(key)) byDate.set(key, []); byDate.get(key).push(r); } const dayKeys = Array.from(byDate.keys()).sort(); const perf = dayKeys.map((day) => { const items = byDate.get(day); const evals = items.filter((i) => i.was_correct !== null); const total = evals.length; const correct = evals.filter((i) => i.was_correct === true).length; const overall = total > 0 ? (correct / total) * 100 : 0; const calc = (type) => { const subset = evals.filter((i) => i.predicted_outcome === type); const t = subset.length; const c = subset.filter((i) => i.was_correct).length; return t > 0 ? (c / t) * 100 : 0; }; return { date: day, overall, home_win: calc('home_win'), draw: calc('draw'), away_win: calc('away_win'), }; }); setPoints(perf); const cssScores = rows .filter((p) => p.css_score !== null && p.css_score !== undefined) .map((p) => p.css_score); setCssScoreCount(cssScores.length); const allEvals = rows.filter((i) => i.was_correct !== null); const total = allEvals.length; const correct = allEvals.filter((i) => i.was_correct === true).length; const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0; const errors = allEvals.map((i) => { const p = (i.css_score ?? i.confidence_score) / 100; const y = i.was_correct ? 1 : 0; return Math.abs(p - y); }); const avgCalibrationError = errors.length > 0 ? Number((errors.reduce((a, b) => a + b, 0) / errors.length).toFixed(3)) : 0; setSummary({ total, accuracy, avgCalibrationError }); } catch (err) { console.error('Failed to load analytics', err); } finally { setLoading(false); } } const widgets = useMemo(() => ({ summary: <SummaryStatsWidget summary={summary} cssScoreCount={cssScoreCount} />, chart: <PerformanceChartWidget data={points} cssScoreCount={cssScoreCount} />, }), [summary, points, cssScoreCount]); if (loading) { return ( <> <PageHeader title="Analytics" metaDescription="Long-term model performance, calibration, comparison" /> <div className="text-center py-12 text-muted-foreground"> Loading analytics data... </div> </> ); } return ( <> <PageHeader title="Analytics" metaDescription="Long-term model performance, calibration, comparison" /> <AppGrid id="analytics_page" widgets={widgets} /> </> ); } 